- [part1](#sketch)
- [part2](#sap-rfc)
- [part3](#warehouse-workbench)




### Sketch
![企业微信截图_16718528925261](https://user-images.githubusercontent.com/40827525/209426372-0d329dd8-8c8b-48ca-a36b-cf8359236fa9.png)



### SAP RFC
```abap
*"----------------------------------------------------------------------
*"*"Local Interface:
*"  IMPORTING
*"     VALUE(I_ZDATE) LIKE  SY-DATUM OPTIONAL
*"     VALUE(I_PLANT) LIKE  LIPS-WERKS OPTIONAL
*"     VALUE(I_DRIVER) LIKE  KNA1-SORTL OPTIONAL
*"     VALUE(I_SALES_ORDER) LIKE  VBAK-VBELN OPTIONAL
*"     VALUE(I_MATERIAL_NO) LIKE  VBAP-MATNR OPTIONAL
*"     VALUE(I_EX_INVOICE) LIKE  VBUK-FKSTK OPTIONAL
*"  EXPORTING
*"     VALUE(O_STATUS) TYPE  CHAR1
*"     VALUE(O_MESSAGE) TYPE  CHAR100
*"  TABLES
*"      IT_PICK_TYPE STRUCTURE  ZSWM040 OPTIONAL
*"      IT_PICK_DRIVER STRUCTURE  ZSWM041 OPTIONAL
*"      IT_PICK_ITEMS STRUCTURE  ZSWM044 OPTIONAL
*"      IT_CHECK_DRIVER STRUCTURE  ZSWM042 OPTIONAL
*"      IT_CHECK_DRTYPE STRUCTURE  ZSWM043 OPTIONAL
*"      IT_CHECK_ITEMS STRUCTURE  ZSWM045 OPTIONAL
*"      IT_DN_DRIVER STRUCTURE  ZSWM037 OPTIONAL
*"      IT_DN_HEADER STRUCTURE  ZSWM033 OPTIONAL
*"      IT_DN_ITEMER STRUCTURE  ZSWM034 OPTIONAL
*"      IT_SUB_ITEMER STRUCTURE  ZSWM047 OPTIONAL
*"      IT_SUB_LMI_ITM STRUCTURE  ZSWM048 OPTIONAL
*"----------------------------------------------------------------------


*********************************************************
"用于记录接口执行时间
DATA: LV_STR_TIMESTAMP TYPE TIMESTAMP.
DATA: LV_END_TIMESTAMP TYPE TIMESTAMP.
GET TIME STAMP FIELD LV_STR_TIMESTAMP.
*********************************************************

"检查条件
IF I_ZDATE = '00000000'.
O_STATUS = 'E'.
O_MESSAGE = 'Delivery Date is Required!'.
RETURN.
ENDIF.

"检查条件
IF I_MATERIAL_NO <> '' AND I_PLANT = ''.
O_STATUS = 'E'.
O_MESSAGE = 'Delivery Plant is Required!'.
RETURN.
ENDIF.

"合作伙伴信息
DATA:IT_VBPA LIKE VBPA OCCURS 0 WITH HEADER LINE.
DATA:IT_KNA1 LIKE KNA1 OCCURS 0 WITH HEADER LINE.
DATA:IT_THEADER LIKE IT_DN_HEADER OCCURS 0 WITH HEADER LINE.
DATA:IT_TITEMER LIKE IT_DN_ITEMER OCCURS 0 WITH HEADER LINE.
DATA:IT_TTEMPER LIKE IT_DN_ITEMER OCCURS 0 WITH HEADER LINE.

DATA: BEGIN OF IT_DNNUM OCCURS 0,
LFDAT LIKE LIKP-LFDAT,
VBELN LIKE LIKP-VBELN,
END OF IT_DNNUM.

"地址信息
DATA:LV_ADDRESS_NUM LIKE ADRC-ADDRNUMBER.
DATA:LV_WTEXT TYPE CHAR250.
DATA:LV_TNAME TYPE CHAR20.

"SET WEIGHT
DATA: LV_UMREZ LIKE MARM-UMREZ VALUE ''.
DATA: LV_UMREN LIKE MARM-UMREN VALUE ''.

"READ TEXT
DATA: LV_STRNAME TYPE STRING.

RANGES:R_SCTID FOR MLGN-LGBKZ.
REFRESH: R_SCTID.
R_SCTID-SIGN   = 'I'.
R_SCTID-OPTION = 'BT'.
R_SCTID-LOW    = 'LMD'.
R_SCTID-HIGH   = 'LMD'.
APPEND R_SCTID.

R_SCTID-SIGN   = 'I'.
R_SCTID-OPTION = 'BT'.
R_SCTID-LOW    = 'LMI'.
R_SCTID-HIGH   = 'LMI'.
APPEND R_SCTID.

R_SCTID-SIGN   = 'I'.
R_SCTID-OPTION ='BT'.
R_SCTID-LOW    = 'LMF'.
R_SCTID-HIGH   = 'LMF'.
APPEND R_SCTID.

*"----------------------------------------------------------------------
FIELD-SYMBOLS: <IT_PICK_TYPE> LIKE IT_PICK_TYPE.
FIELD-SYMBOLS: <IT_PICK_DRIVER> LIKE IT_PICK_DRIVER.
FIELD-SYMBOLS: <IT_PICK_ITEMS> LIKE IT_PICK_ITEMS.

FIELD-SYMBOLS: <IT_DN_DRIVER> LIKE IT_DN_DRIVER.
FIELD-SYMBOLS: <IT_DN_HEADER> LIKE IT_DN_HEADER.
FIELD-SYMBOLS: <IT_DN_ITEMER> LIKE IT_DN_ITEMER.
FIELD-SYMBOLS: <IT_TITEMER> LIKE IT_TITEMER.

FIELD-SYMBOLS: <IT_SUB_ITEMER>  LIKE IT_SUB_ITEMER.
FIELD-SYMBOLS: <IT_SUB_LMI_ITM>  LIKE IT_SUB_LMI_ITM.
*"----------------------------------------------------------------------

CLEAR IT_DNNUM.
REFRESH IT_DNNUM.

"按物料查询订单
IF I_MATERIAL_NO <> '' AND I_PLANT <> ''.
"数据转换补0:
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = I_MATERIAL_NO
IMPORTING
OUTPUT = I_MATERIAL_NO.


    SELECT  LFDAT  VBELN
      INTO CORRESPONDING FIELDS OF TABLE IT_DNNUM
      FROM WB2_V_LIKP_LIPS2
      WHERE VKORG = '1000'
      AND ( LFDAT = I_ZDATE OR BLDAT = I_ZDATE )

      AND LFART = 'LF'
      AND MATNR_I = I_MATERIAL_NO
      AND WERKS_I = I_PLANT.

    SELECT  LFDAT  VBELN
      APPENDING CORRESPONDING FIELDS OF TABLE IT_DNNUM
      FROM WB2_V_LIKP_LIPS2
      WHERE VKORG = '1000'
      AND LFDAT = I_ZDATE
      AND BLDAT = I_ZDATE
      AND LFART = 'LR'
      AND MATNR_I = I_MATERIAL_NO
      AND WERKS_I = I_PLANT.

    SORT IT_DNNUM BY VBELN ASCENDING.
    DELETE ADJACENT DUPLICATES FROM IT_DNNUM COMPARING VBELN.
ENDIF.

CLEAR IT_DN_HEADER.
REFRESH IT_DN_HEADER.

"一般查询：DN单抬头数据
IF LINES( IT_DNNUM ) = 0.
IF I_PLANT <> ''.
SELECT  LIKP~VBELN AS DN_NUM
LIKP~LFART AS DN_TYPE
LIKP~VSBED    LIKP~VSTEL     LIKP~LFDAT
LIKP~KUNNR AS SHIPTO_NUM
LIKP~BTGEW    LIKP~NTGEW     LIKP~GEWEI
VBUK~FKSTK AS INVOICE
ZKNA1_APPEND01~DTYPE AS DTYPE  "MODIFY BY SPARK #4477
INTO CORRESPONDING FIELDS OF TABLE IT_DN_HEADER
FROM LIKP
LEFT JOIN VBUK ON VBUK~VBELN = LIKP~VBELN
LEFT JOIN ZKNA1_APPEND01 ON ZKNA1_APPEND01~KUNNR = LIKP~KUNNR
" AND  ZKNA1_APPEND01~DTYPE = 'B'
WHERE LIKP~VKORG = '1000' AND LIKP~VSTEL = I_PLANT  AND LIKP~LFART = 'LF'
AND ( LIKP~LFDAT = I_ZDATE OR LIKP~BLDAT = I_ZDATE ) .


      SELECT  LIKP~VBELN AS DN_NUM
              LIKP~LFART AS DN_TYPE
              LIKP~VSBED    LIKP~VSTEL     LIKP~LFDAT
              LIKP~KUNNR AS SHIPTO_NUM
              LIKP~BTGEW    LIKP~NTGEW     LIKP~GEWEI
              VBUK~FKSTK AS INVOICE
              ZKNA1_APPEND01~DTYPE AS DTYPE
        APPENDING CORRESPONDING FIELDS OF TABLE IT_DN_HEADER
        FROM LIKP
        LEFT JOIN VBUK ON VBUK~VBELN = LIKP~VBELN
        LEFT JOIN ZKNA1_APPEND01 ON ZKNA1_APPEND01~KUNNR = LIKP~KUNNR
"AND  ZKNA1_APPEND01~DTYPE = 'B'
WHERE LIKP~VKORG = '1000' AND LIKP~VSTEL = I_PLANT  AND LIKP~LFART = 'LR'
AND LIKP~LFDAT = I_ZDATE AND LIKP~BLDAT = I_ZDATE .
ELSE.
SELECT  LIKP~VBELN AS DN_NUM
LIKP~LFART AS DN_TYPE
LIKP~VSBED    LIKP~VSTEL     LIKP~LFDAT
LIKP~KUNNR AS SHIPTO_NUM
LIKP~BTGEW    LIKP~NTGEW     LIKP~GEWEI
VBUK~FKSTK AS INVOICE
ZKNA1_APPEND01~DTYPE AS DTYPE
INTO CORRESPONDING FIELDS OF TABLE IT_DN_HEADER
FROM LIKP
LEFT JOIN VBUK ON VBUK~VBELN = LIKP~VBELN
LEFT JOIN ZKNA1_APPEND01 ON ZKNA1_APPEND01~KUNNR = LIKP~KUNNR
"AND  ZKNA1_APPEND01~DTYPE = 'B'
WHERE LIKP~VKORG = '1000' AND LIKP~LFART = 'LF'
AND ( LIKP~LFDAT = I_ZDATE OR LIKP~BLDAT = I_ZDATE )  .

      SELECT LIKP~VBELN AS DN_NUM
             LIKP~LFART AS DN_TYPE
             LIKP~VSBED    LIKP~VSTEL     LIKP~LFDAT
             LIKP~KUNNR AS SHIPTO_NUM
             LIKP~BTGEW    LIKP~NTGEW     LIKP~GEWEI
             VBUK~FKSTK AS INVOICE
             ZKNA1_APPEND01~DTYPE AS DTYPE
       APPENDING CORRESPONDING FIELDS OF TABLE IT_DN_HEADER
       FROM LIKP
       LEFT JOIN VBUK ON VBUK~VBELN = LIKP~VBELN
       LEFT JOIN ZKNA1_APPEND01 ON ZKNA1_APPEND01~KUNNR = LIKP~KUNNR
        "AND  ZKNA1_APPEND01~DTYPE = 'B'
       WHERE LIKP~VKORG = '1000' AND  LIKP~LFART = 'LR'
          AND LIKP~LFDAT = I_ZDATE AND LIKP~BLDAT = I_ZDATE  .
    ENDIF.
ENDIF.

"条件查询：按物料查询
IF LINES( IT_DNNUM ) > 0.
SELECT  LIKP~VBELN AS DN_NUM
LIKP~LFART AS DN_TYPE
LIKP~VSBED    LIKP~VSTEL    LIKP~LFDAT
LIKP~KUNNR AS SHIPTO_NUM
LIKP~BTGEW    LIKP~NTGEW    LIKP~GEWEI
VBUK~FKSTK AS INVOICE
INTO CORRESPONDING FIELDS OF TABLE IT_DN_HEADER
FROM LIKP
LEFT JOIN VBUK ON VBUK~VBELN = LIKP~VBELN
FOR ALL ENTRIES IN IT_DNNUM
WHERE LIKP~VBELN = IT_DNNUM-VBELN.
ENDIF.

"排除已经INVOICE的单号
IF I_EX_INVOICE <> ''.
DELETE IT_DN_HEADER WHERE INVOICE = 'C'. "C表示已经完成开发票
ENDIF.

"技术原因排序：用于后续查询
DELETE IT_DN_HEADER WHERE SO_NUM = '0000000000'.
SORT IT_DN_HEADER BY DN_NUM ASCENDING.

"查询合作伙伴信息
IF LINES( IT_DN_HEADER ) > 0.
SELECT VBELN PARVW KUNNR ADRNR
INTO CORRESPONDING FIELDS OF TABLE IT_VBPA
FROM VBPA
FOR ALL ENTRIES IN IT_DN_HEADER
WHERE VBELN = IT_DN_HEADER-DN_NUM
AND ( PARVW = 'WE' OR PARVW = 'Z1' OR PARVW = 'Z3' OR PARVW = 'Z4'  ).
"排序
SORT IT_VBPA BY VBELN PARVW ASCENDING.

    "查询所有派单主数据信息1~2000
    IF LINES( IT_VBPA ) > 0.
      SELECT KUNNR NAME1 NAME2 SORTL
      INTO CORRESPONDING FIELDS OF TABLE IT_KNA1
        FROM KNA1
        WHERE KUNNR BETWEEN '0000000001' AND '0000002000'.
      "排序
      SORT IT_KNA1 BY KUNNR ASCENDING .
    ENDIF.
ENDIF.

LOOP AT IT_DN_HEADER ASSIGNING <IT_DN_HEADER>.
"特殊处理：避免跨日开单的数据无法同步显示到SO APP，默认修改为同步日期。---BY JOSEPH 20211026
<IT_DN_HEADER>-LFDAT = I_ZDATE.

    "读取对应的SO订单
    SELECT SINGLE VGBEL INTO <IT_DN_HEADER>-SO_NUM FROM LIPS WHERE VBELN = <IT_DN_HEADER>-DN_NUM AND VGBEL <> ''.


    IF <IT_DN_HEADER>-SO_NUM <> ''.
      "读取SO的订单类型
      SELECT SINGLE AUART INTO <IT_DN_HEADER>-SO_TYPE FROM VBAK WHERE VBELN = <IT_DN_HEADER>-SO_NUM.

      "獲取SO的header-warehouse text
      CLEAR LV_STRNAME.
      LV_STRNAME = <IT_DN_HEADER>-SO_NUM.
      PERFORM READ_SO_TEXT USING 'Z002' LV_STRNAME 'VBBK' <IT_DN_HEADER>-HW_TEXT.
    ENDIF.

    "读取SHIP TO信息
    CLEAR LV_ADDRESS_NUM.
    CLEAR IT_VBPA.
    READ TABLE IT_VBPA WITH KEY VBELN = <IT_DN_HEADER>-DN_NUM PARVW = 'WE' BINARY SEARCH.
    IF SY-SUBRC = 0.
      LV_ADDRESS_NUM = IT_VBPA-ADRNR.
    ENDIF.
    IF NOT LV_ADDRESS_NUM IS INITIAL.
      SELECT SINGLE NAME1  INTO ( <IT_DN_HEADER>-SHIPTO_NAM ) FROM ADRC WHERE ADDRNUMBER = LV_ADDRESS_NUM.
    ENDIF.

    "读取司机信息
    CLEAR IT_VBPA.
    READ TABLE IT_VBPA WITH KEY VBELN = <IT_DN_HEADER>-DN_NUM PARVW = 'Z1' BINARY SEARCH.
    IF SY-SUBRC = 0.
      <IT_DN_HEADER>-SJZ1_NUM = IT_VBPA-KUNNR.
      READ TABLE IT_KNA1 WITH  KEY KUNNR = <IT_DN_HEADER>-SJZ1_NUM BINARY SEARCH.
      IF SY-SUBRC = 0.
        <IT_DN_HEADER>-SJZ1_NAM = IT_KNA1-SORTL.
      ENDIF.
    ENDIF.

    "客人上门自提
    IF <IT_DN_HEADER>-SJZ1_NAM = '' AND <IT_DN_HEADER>-VSBED = '02'.
      CONCATENATE <IT_DN_HEADER>-VSTEL '-PKUP' INTO <IT_DN_HEADER>-SJZ1_NUM.
      CONCATENATE <IT_DN_HEADER>-VSTEL '-PickUp' INTO <IT_DN_HEADER>-SJZ1_NAM.
    ENDIF.

    "读取站数信息
    CLEAR IT_VBPA.
    READ TABLE IT_VBPA WITH KEY VBELN = <IT_DN_HEADER>-DN_NUM PARVW = 'Z3' BINARY SEARCH.
    IF SY-SUBRC = 0.
      <IT_DN_HEADER>-SJZ3_NUM = IT_VBPA-KUNNR.
      READ TABLE IT_KNA1 WITH  KEY KUNNR = <IT_DN_HEADER>-SJZ3_NUM BINARY SEARCH.
      IF SY-SUBRC = 0.
        <IT_DN_HEADER>-SJZ3_NAM = IT_KNA1-NAME2.
      ENDIF.
    ENDIF.

    "读取货车信息
    CLEAR IT_VBPA.
    READ TABLE IT_VBPA WITH KEY VBELN = <IT_DN_HEADER>-DN_NUM PARVW = 'Z4' BINARY SEARCH.
    IF SY-SUBRC = 0.
      <IT_DN_HEADER>-SJZ4_NUM = IT_VBPA-KUNNR.
      READ TABLE IT_KNA1 WITH  KEY KUNNR = <IT_DN_HEADER>-SJZ4_NUM BINARY SEARCH.
      IF SY-SUBRC = 0.
        <IT_DN_HEADER>-SJZ4_NAM = IT_KNA1-SORTL.
      ENDIF.
    ENDIF.

    "司机上车次序---ROUND
    <IT_DN_HEADER>-ROUND = ''.
    IF <IT_DN_HEADER>-SJZ1_NAM <> ''.
      DATA:LV_NAME TYPE INT4 VALUE 0.
      LV_NAME = CL_ABAP_LIST_UTILITIES=>DYNAMIC_OUTPUT_LENGTH( <IT_DN_HEADER>-SJZ1_NAM ).
      IF LV_NAME > 6.
        SELECT SINGLE ROUND INTO <IT_DN_HEADER>-ROUND
          FROM ZTWM012Y
          WHERE AEDAT = I_ZDATE
          AND VSTEL = I_PLANT
          AND SORTL = <IT_DN_HEADER>-SJZ1_NAM.
      ELSE.
        SELECT SINGLE ROUND INTO <IT_DN_HEADER>-ROUND
          FROM ZTWM012N
          WHERE AEDAT = I_ZDATE
          AND VSTEL = I_PLANT
          AND SORTL = <IT_DN_HEADER>-SJZ1_NAM.
      ENDIF.
    ENDIF.

    "查询DN对应的GROUP号码
    CLEAR <IT_DN_HEADER>-DN_GROUP.
    CLEAR <IT_DN_HEADER>-DN_GROUP_NAME.
    SELECT SINGLE SAMMG INTO <IT_DN_HEADER>-DN_GROUP FROM VBSS WHERE VBELN = <IT_DN_HEADER>-DN_NUM.
    IF <IT_DN_HEADER>-DN_GROUP IS NOT INITIAL.
      SELECT SINGLE VTEXT INTO <IT_DN_HEADER>-DN_GROUP_NAME FROM VBSK WHERE SAMMG = <IT_DN_HEADER>-DN_GROUP.
    ENDIF.
ENDLOOP.

"过滤没有分配司机的订单
DELETE IT_DN_HEADER WHERE SO_NUM = ''.
DELETE IT_DN_HEADER WHERE SJZ1_NAM = '' AND VSBED <> '02'.

"按司机过滤数据
IF I_DRIVER <> ''.
DELETE IT_DN_HEADER WHERE SJZ1_NAM <> I_DRIVER.
ENDIF.

"按销售订单过滤数据
IF I_SALES_ORDER <> ''.
"数据转换补0:
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = I_SALES_ORDER
IMPORTING
OUTPUT = I_SALES_ORDER.
DELETE IT_DN_HEADER WHERE SO_NUM <> I_SALES_ORDER.
ENDIF.

SORT IT_DN_HEADER BY DN_NUM ASCENDING.
IF LINES( IT_DN_HEADER ) > 0.
SELECT
LIPS~VGBEL AS SO_NUM
LIPS~VGPOS AS SO_ITEM
LIPS~VBELN AS DN_NUM
LIPS~POSNR AS DN_ITEM
LIPS~MTART    MATKL
LIPS~MATNR
LIPS~ARKTX
LIPS~MEINS
LIPS~WERKS
LIPS~LGNUM
ZSJMAT_EXTEND~WARHOUSETEXT AS WHTXT
ZSJMAT_EXTEND~SOTEXT AS SOTXT
ZSJMAT_EXTEND~SOTEXT2       "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
ZSJMAT_EXTEND2~PRESALE      "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
LIPS~LFIMG    LIPS~VRKME
LIPS~NTGEW    LIPS~BRGEW    LIPS~GEWEI
INTO CORRESPONDING FIELDS OF TABLE IT_DN_ITEMER
FROM LIPS
LEFT JOIN ZSJMAT_EXTEND ON LIPS~MATNR = ZSJMAT_EXTEND~MATNR
LEFT JOIN ZSJMAT_EXTEND2 ON LIPS~MATNR = ZSJMAT_EXTEND2~MATNR AND LIPS~WERKS = ZSJMAT_EXTEND2~WERKS
FOR ALL ENTRIES IN IT_DN_HEADER
WHERE
LIPS~VBELN = IT_DN_HEADER-DN_NUM.
ENDIF.
SORT IT_DN_ITEMER BY DN_NUM DN_ITEM ASCENDING.

"获取ONHAND 和 明天PO到货*****************************
IT_TITEMER[] = IT_DN_ITEMER[].
SORT IT_TITEMER BY WERKS MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING WERKS MATNR .
DATA:LV_MEINS LIKE MARA-MEINS.
DATA:LV_TODAY LIKE SY-DATUM.
LV_TODAY = ( I_ZDATE - 1 ).
LOOP AT IT_TITEMER ASSIGNING <IT_TITEMER>.
"计算ATR IN BASE UNIT
CALL FUNCTION 'ZRFMM005'
EXPORTING
P_BDATE    = LV_TODAY
P_MATNR    = <IT_TITEMER>-MATNR
P_WERKS    = <IT_TITEMER>-WERKS
IMPORTING
RTN_ONHAND = <IT_TITEMER>-ONHAND
RTN_TOMIPO = <IT_TITEMER>-TOMIPO.
CLEAR LV_MEINS.
SELECT SINGLE MEINS INTO LV_MEINS FROM MARA WHERE MATNR = <IT_TITEMER>-MATNR.
IF SY-SUBRC = 0 AND LV_MEINS <> <IT_TITEMER>-VRKME.
CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR              = <IT_TITEMER>-MATNR
I_IN_ME              = LV_MEINS
I_OUT_ME             = <IT_TITEMER>-VRKME
I_MENGE              = <IT_TITEMER>-ONHAND
IMPORTING
E_MENGE              = <IT_TITEMER>-ONHAND
EXCEPTIONS
ERROR_IN_APPLICATION = 1
ERROR                = 2
OTHERS               = 3.
IF SY-SUBRC <> 0.
ENDIF.

      CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
        EXPORTING
          I_MATNR              = <IT_TITEMER>-MATNR
          I_IN_ME              = LV_MEINS
          I_OUT_ME             = <IT_TITEMER>-VRKME
          I_MENGE              = <IT_TITEMER>-TOMIPO
        IMPORTING
          E_MENGE              = <IT_TITEMER>-TOMIPO
        EXCEPTIONS
          ERROR_IN_APPLICATION = 1
          ERROR                = 2
          OTHERS               = 3.
      IF SY-SUBRC <> 0.
      ENDIF.
    ENDIF.
ENDLOOP.

DATA:ISPC_ITEM TYPE STRING VALUE 'N'.
DATA:ISCW_ITEM TYPE STRING VALUE 'F'.
DATA:ISRE_ITEM TYPE STRING VALUE 'N'.
"循环修改数据
LOOP AT IT_DN_ITEMER ASSIGNING <IT_DN_ITEMER>.
IF <IT_DN_ITEMER>-PRESALE = 'Y'.       "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
<IT_DN_ITEMER>-PRESALE = '預售 PRESALE'.
ENDIF.

    "#4129(1)表:IT_DN_ITEMER，添加字段:Z12、Z13、Z14、Z31_20220606 DORIS
    CLEAR: <IT_DN_ITEMER>-Z12,<IT_DN_ITEMER>-Z13, <IT_DN_ITEMER>-Z14,<IT_DN_ITEMER>-Z31.
    SELECT SINGLE Z12 Z13 Z14 INTO (<IT_DN_ITEMER>-Z12,<IT_DN_ITEMER>-Z13, <IT_DN_ITEMER>-Z14)
      FROM ZSJMAT_EXTEND_MM WHERE MATNR = <IT_DN_ITEMER>-MATNR.
    SELECT SINGLE Z31 INTO <IT_DN_ITEMER>-Z31 FROM ZSJMAT_EXTEND_WM WHERE MATNR = <IT_DN_ITEMER>-MATNR.

    "外部物料组
    SELECT SINGLE EXTWG INTO <IT_DN_ITEMER>-EXTWG FROM MARA WHERE MATNR = <IT_DN_ITEMER>-MATNR.
    "WM Section Indicator
    SELECT SINGLE LGBKZ INTO <IT_DN_ITEMER>-SCTID FROM MLGN WHERE MATNR = <IT_DN_ITEMER>-MATNR AND LGNUM = <IT_DN_ITEMER>-LGNUM.

    "显示Warehouse Text
    CONCATENATE <IT_DN_ITEMER>-DN_NUM <IT_DN_ITEMER>-DN_ITEM  INTO LV_TNAME.
    CLEAR LV_WTEXT.
    PERFORM FRM_READ_TEXT USING LV_WTEXT LV_TNAME 'Z002' 'VBBP'.
    <IT_DN_ITEMER>-WHOUSE_TEXT1 = LV_WTEXT.

    "读取物料的SET WEIGHT数值
    CLEAR LV_UMREZ.    CLEAR LV_UMREN.
    "1.如果基础单位是LB，则以销售单位从MARM捉取预设磅重。
    IF <IT_DN_ITEMER>-MEINS = 'LB' AND <IT_DN_ITEMER>-EXTWG = 'CW'.
      SELECT SINGLE UMREZ UMREN INTO (LV_UMREZ,LV_UMREN) FROM MARM WHERE MATNR = <IT_DN_ITEMER>-MATNR AND MEINH = <IT_DN_ITEMER>-VRKME.
      IF LV_UMREZ > 0 AND LV_UMREN > 0.
        <IT_DN_ITEMER>-SETWEIGHT = LV_UMREZ / LV_UMREN.
      ENDIF.
    ENDIF.
    "2.如果基础单位不是LB，则以LB单位从MARA捉取预设磅重。
    IF <IT_DN_ITEMER>-MEINS <> 'LB' AND <IT_DN_ITEMER>-EXTWG = 'CW'.
      SELECT SINGLE UMREZ UMREN INTO (LV_UMREZ,LV_UMREN) FROM MARM WHERE MATNR = <IT_DN_ITEMER>-MATNR AND MEINH = 'LB'.
      IF LV_UMREZ > 0 AND LV_UMREN > 0.
        <IT_DN_ITEMER>-SETWEIGHT = LV_UMREZ / LV_UMREN.
      ENDIF.
    ENDIF.

    "获取QC TEXT信息
    SELECT SINGLE KONDM ZITMTXT01 INTO ( <IT_DN_ITEMER>-QC_TYPE,<IT_DN_ITEMER>-QC_TEXT )
      FROM VBAP WHERE VBELN = <IT_DN_ITEMER>-SO_NUM AND POSNR = <IT_DN_ITEMER>-SO_ITEM.
    IF <IT_DN_ITEMER>-QC_TYPE = '04' AND <IT_DN_ITEMER>-QC_TEXT = ''.
      <IT_DN_ITEMER>-QC_TEXT = 'Please,Do not miss pack!'.
    ENDIF.
    IF <IT_DN_ITEMER>-QC_TYPE = '05' AND <IT_DN_ITEMER>-QC_TEXT = ''.
      <IT_DN_ITEMER>-QC_TEXT = 'Return Item'.
    ENDIF.
    IF <IT_DN_ITEMER>-QC_TYPE = '06' AND <IT_DN_ITEMER>-QC_TEXT = ''.
      <IT_DN_ITEMER>-QC_TEXT = 'Label'.
    ENDIF.
    IF <IT_DN_ITEMER>-QC_TYPE = '01' AND <IT_DN_ITEMER>-QC_TEXT = ''.
      <IT_DN_ITEMER>-QC_TEXT = 'Normal'.
    ENDIF.
    IF <IT_DN_ITEMER>-QC_TYPE = '02' AND <IT_DN_ITEMER>-QC_TEXT = ''.
      <IT_DN_ITEMER>-QC_TEXT = 'Spare parts'.
    ENDIF.

    "读取ONHAND 和 明天到货PO
    READ TABLE IT_TITEMER WITH KEY WERKS = <IT_DN_ITEMER>-WERKS MATNR = <IT_DN_ITEMER>-MATNR.
    IF SY-SUBRC = 0.
      <IT_DN_ITEMER>-ONHAND = IT_TITEMER-ONHAND.
      <IT_DN_ITEMER>-TOMIPO = IT_TITEMER-TOMIPO.
    ENDIF.

    "单位转换
    CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
      EXPORTING
        INPUT          = <IT_DN_ITEMER>-VRKME
      IMPORTING
        OUTPUT         = <IT_DN_ITEMER>-VRKME
      EXCEPTIONS
        UNIT_NOT_FOUND = 1
        OTHERS         = 2.

    "物料排序***************************************************************
    SELECT SINGLE LTKZA INTO <IT_DN_ITEMER>-LTKZA FROM MLGN WHERE LGNUM = <IT_DN_ITEMER>-LGNUM AND MATNR = <IT_DN_ITEMER>-MATNR.
    "----判斷並標記PC ISPC_ITEM
    ISPC_ITEM = 'N'.
    SEARCH <IT_DN_ITEMER>-MATNR FOR 'PC'.
    IF SY-SUBRC = 0.
      ISPC_ITEM = 'Y'.
    ENDIF.
    "----判斷並標記CW ISCW_ITEM
    ISCW_ITEM = 'F'.
    SEARCH <IT_DN_ITEMER>-MATNR FOR 'CW'.
    IF SY-SUBRC = 0.
      ISCW_ITEM = 'T'.
    ENDIF.
    "----010 ZHWR R-Item（with CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHWR'.
      <IT_DN_ITEMER>-SORTBY = 10.
    ENDIF.
    "----020 ZHWF Fresh-MaetItem 新鲜肉类（with CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHWF'.
      <IT_DN_ITEMER>-SORTBY = 20.
    ENDIF.
    "----021 ZHWA（F）Fresh-DryGoods 新鲜干货（with CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHWA' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'CL'.
      <IT_DN_ITEMER>-SORTBY = 21.
    ENDIF.
    "----030 CW-Item Chicken ZHW1
    IF <IT_DN_ITEMER>-MTART = 'ZHW1' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 30.
    ENDIF.
    "----031 CW-Item Beef ZHW2
    IF <IT_DN_ITEMER>-MTART = 'ZHW2' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 31.
    ENDIF.
    "----032 CW-Item Pock ZHW3
    IF <IT_DN_ITEMER>-MTART = 'ZHW3' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 32.
    ENDIF.
    "----033 CW-Item Shrimp ZHW4
    IF <IT_DN_ITEMER>-MTART = 'ZHW4' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 33.
    ENDIF.
    "----034 CW-Item Saefood ZHW5
    IF <IT_DN_ITEMER>-MTART = 'ZHW5' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 34.
    ENDIF.
    "----035 CW-Item Others ZHW6
    IF <IT_DN_ITEMER>-MTART = 'ZHW6' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 35.
    ENDIF.
    "----036 CW-Item Vegetables ZHW7
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 36.
    ENDIF.
    "----037 CW-Item DryGoods-Normal ZHW8
    IF <IT_DN_ITEMER>-MTART = 'ZHW8' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 37.
    ENDIF.
    "----038 CW-Item DryGoods-Frozen ZHWA
    IF <IT_DN_ITEMER>-MTART = 'ZHWA' AND ISCW_ITEM = 'T'.
      <IT_DN_ITEMER>-SORTBY = 38.
    ENDIF.
    "----040 ZHW1 冻肉-鸡类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW1' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 40.
    ENDIF.
    "----050 ZHW2 冻肉-牛类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW2' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 50.
    ENDIF.
    "----060 ZHW3 冻肉-猪类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW3' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 60.
    ENDIF.
    "----070 ZHW4 冻肉-虾类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW4' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 70.
    ENDIF.
    "----071 ZHW5 冻肉-海鲜类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW5' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 71.
    ENDIF.
    "----072 ZHW6 冻肉-杂类（without PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW6' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ' .
      <IT_DN_ITEMER>-SORTBY = 72.
    ENDIF.
    "----080 ZHW7 Frozen Vegetables 急冻蔬菜（with PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISCW_ITEM = 'F' AND  <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ'.
      <IT_DN_ITEMER>-SORTBY = 80.
    ENDIF.
    "----090 PC Chicken ZHW1
    IF <IT_DN_ITEMER>-MTART = 'ZHW1' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 90.
    ENDIF.
    "----091 PC Beef ZHW2
    IF <IT_DN_ITEMER>-MTART = 'ZHW2' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 91.
    ENDIF.
    "----092 PC Pock ZHW3
    IF <IT_DN_ITEMER>-MTART = 'ZHW3' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 92.
    ENDIF.
    "----093 PC Shrimp ZHW4
    IF <IT_DN_ITEMER>-MTART = 'ZHW4' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 93.
    ENDIF.
    "----094 PC Saefood ZHW5
    IF <IT_DN_ITEMER>-MTART = 'ZHW5' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 94.
    ENDIF.
    "----095 PC Others ZHW6
    IF <IT_DN_ITEMER>-MTART = 'ZHW6' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F' AND  <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ'.
      <IT_DN_ITEMER>-SORTBY = 95.
    ENDIF.
    "----096 Frozen DRY Goods（without PC） ZHWA
    IF <IT_DN_ITEMER>-MTART = 'ZHWA' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F' AND  <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ'.
      <IT_DN_ITEMER>-SORTBY = 96.
    ENDIF.
    "----097 PC-Item / Frozen DRY Goods（with PC） ZHWA
    IF <IT_DN_ITEMER>-MTART = 'ZHWA' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F' AND  <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ'.
      <IT_DN_ITEMER>-SORTBY = 97.
    ENDIF.
    "----100 ZHW6 Normal MeatItem
    IF <IT_DN_ITEMER>-MTART = 'ZHW6' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'DR'.
      <IT_DN_ITEMER>-SORTBY = 100.
    ENDIF.
    "----101 ZHW8 Normal Dry Goods（without CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW8' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 101.
    ENDIF.
    "----102 ZHW8 Normal Dry Goods（with PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW8' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F'.
      <IT_DN_ITEMER>-SORTBY = 102.
    ENDIF.
    "----110 ZHW7 Vegetables-Cooler（without CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'CL'.
      <IT_DN_ITEMER>-SORTBY = 110.
    ENDIF.
    "----111 ZHW7 Vegetables-Normal（without CW、PC）
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISPC_ITEM = 'N' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'DR'.
      <IT_DN_ITEMER>-SORTBY = 111.
    ENDIF.
    "----120 ZHW7 PC Vegetables-Cooler
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'CL'.
      <IT_DN_ITEMER>-SORTBY = 120.
    ENDIF.
    "----121 ZHW7 PC Vegetables-Normal
    IF <IT_DN_ITEMER>-MTART = 'ZHW7' AND ISPC_ITEM = 'Y' AND ISCW_ITEM = 'F' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'DR'.
      <IT_DN_ITEMER>-SORTBY = 121.
    ENDIF.
    "----130 ZHWS Service Item
    IF <IT_DN_ITEMER>-MTART = 'ZHWS' .
      <IT_DN_ITEMER>-SORTBY = 130.
    ENDIF.
    "----131 ZNLA Service Item
    IF <IT_DN_ITEMER>-MTART = 'ZNLA' .
      <IT_DN_ITEMER>-SORTBY = 131.
    ENDIF.
    "----999 No Match（為空時自動排序到底部）
    IF <IT_DN_ITEMER>-SORTBY = 0.
      <IT_DN_ITEMER>-SORTBY = 999.
    ENDIF.

    "补充执货数据*******Add by Joseph
    READ TABLE IT_DN_HEADER WITH KEY SO_NUM = <IT_DN_ITEMER>-SO_NUM.
    IF SY-SUBRC = 0.
      <IT_DN_ITEMER>-SO_TYPE = IT_DN_HEADER-SO_TYPE.
    ENDIF.

    READ TABLE IT_DN_HEADER WITH KEY DN_NUM = <IT_DN_ITEMER>-DN_NUM.
    IF SY-SUBRC = 0.
      <IT_DN_ITEMER>-DN_DATE = IT_DN_HEADER-LFDAT.
      <IT_DN_ITEMER>-SJZ1_NUM = IT_DN_HEADER-SJZ1_NUM.
      <IT_DN_ITEMER>-SJZ1_NAM = IT_DN_HEADER-SJZ1_NAM.
    ENDIF.

    "分货单分类信息: 排除Yamiemal & YamiBuy订单
    IF <IT_DN_ITEMER>-SO_TYPE <> 'ZPM' AND <IT_DN_ITEMER>-SO_TYPE <> 'ZYB'.
      SELECT SINGLE TYPENO TYPENOTXT INTO (<IT_DN_ITEMER>-TYPENO, <IT_DN_ITEMER>-TYPENOTXT)
        FROM ZTWM026
        WHERE WERKS = <IT_DN_ITEMER>-WERKS
          AND MTART = <IT_DN_ITEMER>-MTART
          AND MATKL = <IT_DN_ITEMER>-MATKL
          AND LGBKZ = <IT_DN_ITEMER>-SCTID.
      IF <IT_DN_ITEMER>-SO_TYPE <> 'RE' AND <IT_DN_ITEMER>-TYPENO = ''.
        <IT_DN_ITEMER>-TYPENO = 'NOM'.
        <IT_DN_ITEMER>-TYPENOTXT = 'Do not match'.
      ENDIF.

      "添加預售類型  _MODIFY BY RT 20220505  #4293(2)
      IF <IT_DN_ITEMER>-PRESALE = '預售 PRESALE' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'FZ'.
        <IT_DN_ITEMER>-TYPENO = 'PR1'.
        <IT_DN_ITEMER>-TYPENOTXT = '預售PRESALE-FREEZER'.
      ELSEIF <IT_DN_ITEMER>-PRESALE = '預售 PRESALE' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'CL'.
        <IT_DN_ITEMER>-TYPENO = 'PR2'.
        <IT_DN_ITEMER>-TYPENOTXT = '預售PRESALE-COOLER'.
      ELSEIF <IT_DN_ITEMER>-PRESALE = '預售 PRESALE' AND <IT_DN_ITEMER>-LTKZA+0(2) = 'DR'.
        <IT_DN_ITEMER>-TYPENO = 'PR3'.
        <IT_DN_ITEMER>-TYPENOTXT = '預售PRESALE-DRY'.
      ENDIF.
    ENDIF.

    "物料特殊标识：WET ~~,FRI,LMF,LM,LMD
    <IT_DN_ITEMER>-MATAG1 = ''.
    IF <IT_DN_ITEMER>-SCTID = 'WTI'.
      <IT_DN_ITEMER>-MATAG1 = '~~'.
    ENDIF.
    IF <IT_DN_ITEMER>-SCTID = 'FRI'.
      <IT_DN_ITEMER>-MATAG1 = 'FRI'.
    ENDIF.
    IF <IT_DN_ITEMER>-SCTID = 'LMD'.
      <IT_DN_ITEMER>-MATAG1 = 'LMD'.
    ENDIF.
    IF <IT_DN_ITEMER>-SCTID = 'LMF'.
      <IT_DN_ITEMER>-MATAG1 = 'LMF'.
    ENDIF.
    IF <IT_DN_ITEMER>-SCTID = 'LMI'.
      <IT_DN_ITEMER>-MATAG1 = 'LMI'.
    ENDIF.

    "Dock位置
    <IT_DN_ITEMER>-DOCK = ''.
    SELECT SINGLE DOCK INTO <IT_DN_ITEMER>-DOCK
        FROM ZTWM012N
        WHERE AEDAT = <IT_DN_ITEMER>-DN_DATE
        AND VSTEL = <IT_DN_ITEMER>-WERKS
        AND SORTL = <IT_DN_ITEMER>-SJZ1_NAM.
ENDLOOP.

SORT IT_DN_ITEMER BY SORTBY ASCENDING MATNR ASCENDING.

"返回数据前最后排序
SORT IT_DN_HEADER BY VSTEL ROUND SJZ1_NAM ASCENDING SJZ3_NUM DESCENDING.
"拷贝数据用于查找当前司机总站数
IT_THEADER[] =  IT_DN_HEADER[].
SORT IT_THEADER BY VSTEL SJZ1_NAM ASCENDING SJZ3_NUM DESCENDING.
DELETE ADJACENT DUPLICATES FROM IT_THEADER COMPARING VSTEL SJZ1_NAM.

"汇总司机信息
LOOP AT IT_DN_HEADER.
READ TABLE IT_DN_DRIVER WITH KEY VSTEL = IT_DN_HEADER-VSTEL SJZ1_NUM = IT_DN_HEADER-SJZ1_NUM.
IF SY-SUBRC <> 0.
IT_DN_DRIVER-VSTEL = IT_DN_HEADER-VSTEL.
IT_DN_DRIVER-LFDAT = IT_DN_HEADER-LFDAT.
IT_DN_DRIVER-SJZ1_NUM = IT_DN_HEADER-SJZ1_NUM.
IT_DN_DRIVER-SJZ1_NAM = IT_DN_HEADER-SJZ1_NAM.
IT_DN_DRIVER-SORTBY = '999'.
IT_DN_DRIVER-DOCK = ''.
SELECT SINGLE DNO DOCK INTO ( IT_DN_DRIVER-SORTBY ,IT_DN_DRIVER-DOCK )
FROM ZTWM012N
WHERE AEDAT = IT_DN_HEADER-LFDAT
AND VSTEL = IT_DN_HEADER-VSTEL
AND SORTL = IT_DN_HEADER-SJZ1_NAM.
IT_DN_DRIVER-ROUND = IT_DN_HEADER-ROUND.
IT_DN_DRIVER-SJZ4_NUM = IT_DN_HEADER-SJZ4_NUM.
IT_DN_DRIVER-SJZ4_NAM = IT_DN_HEADER-SJZ4_NAM.
CLEAR IT_DN_DRIVER-TOTAL_STOP.
READ TABLE IT_THEADER WITH KEY SJZ1_NUM = IT_DN_HEADER-SJZ1_NUM.
IF SY-SUBRC = 0.
IT_DN_DRIVER-TOTAL_STOP = IT_THEADER-SJZ3_NAM.
ENDIF.
APPEND IT_DN_DRIVER.
CLEAR IT_DN_DRIVER.
ENDIF.
ENDLOOP.

"判断司机类型:01 SJ送货；02Yamimeal送货；03混合SJ和Yamimeal送货
SORT IT_DN_DRIVER BY SJZ1_NAM ASCENDING.
LOOP AT IT_DN_DRIVER ASSIGNING <IT_DN_DRIVER>.
IT_THEADER[] = IT_DN_HEADER[].
DELETE IT_THEADER WHERE SJZ1_NAM <> <IT_DN_DRIVER>-SJZ1_NAM.
SORT IT_THEADER BY SO_TYPE ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_THEADER COMPARING SO_TYPE.
"先判断有无Yamimeal送货
READ TABLE IT_THEADER WITH KEY SO_TYPE = 'ZPM'.
IF SY-SUBRC = 0.
"默认标记02Yamimeal送货
<IT_DN_DRIVER>-DLY_TYPE = '02'.
"再判断有无非Yamimeal送货，有即表示混合送货
LOOP AT IT_THEADER WHERE SO_TYPE <> 'ZPM'.
"如果不等于ZPM订单，并且SHIPTO号码没有YM前缀的情况下为非Yamimeal订单
IF IT_THEADER-SHIPTO_NUM+0(2) <> 'YM'.
<IT_DN_DRIVER>-DLY_TYPE = '03'.
ENDIF.
ENDLOOP.
ELSE.
"查询不到Yamimeal订单，则默认01 SJ送货
<IT_DN_DRIVER>-DLY_TYPE = '01'.
ENDIF.
ENDLOOP.
"返回数据前最后排序
SORT IT_DN_DRIVER BY VSTEL SORTBY ROUND SJZ1_NAM ASCENDING.

"从交货明细IT_DN_ITEMER中提取货仓-分类信息 & 分类下的司机列表
LOOP AT IT_DN_ITEMER.
"货仓-分类信息
READ TABLE IT_PICK_TYPE WITH KEY PLANT = IT_DN_ITEMER-WERKS TYPENO = IT_DN_ITEMER-TYPENO.
IF SY-SUBRC <> 0.
IT_PICK_TYPE-PLANT = IT_DN_ITEMER-WERKS.
IT_PICK_TYPE-DN_DATE = IT_DN_ITEMER-DN_DATE.
IT_PICK_TYPE-TYPENO = IT_DN_ITEMER-TYPENO.
IT_PICK_TYPE-TYPENOTXT = IT_DN_ITEMER-TYPENOTXT.
IT_PICK_TYPE-TOTAL_ITEMS = 0.
IT_PICK_TYPE-TOTAL_GWGHT = 0.
IT_PICK_TYPE-GEWEI  = 'LB'.
APPEND IT_PICK_TYPE.
CLEAR IT_PICK_TYPE.
ENDIF.

    "分类下的司机列表
    READ TABLE IT_PICK_DRIVER WITH KEY PLANT = IT_DN_ITEMER-WERKS TYPENO = IT_DN_ITEMER-TYPENO SJZ1_NUM = IT_DN_ITEMER-SJZ1_NUM.
    IF SY-SUBRC <> 0.
      IT_PICK_DRIVER-PLANT = IT_DN_ITEMER-WERKS.
      IT_PICK_DRIVER-DN_DATE = IT_DN_ITEMER-DN_DATE.
      IT_PICK_DRIVER-TYPENO = IT_DN_ITEMER-TYPENO.
      IT_PICK_DRIVER-TYPENOTXT = IT_DN_ITEMER-TYPENOTXT.
      IT_PICK_DRIVER-SJZ1_NUM = IT_DN_ITEMER-SJZ1_NUM.
      IT_PICK_DRIVER-SJZ1_NAM = IT_DN_ITEMER-SJZ1_NAM.
      READ TABLE IT_DN_DRIVER WITH KEY VSTEL = IT_DN_ITEMER-WERKS SJZ1_NUM = IT_DN_ITEMER-SJZ1_NUM.
      IF SY-SUBRC = 0.
        IT_PICK_DRIVER-SORTBY = IT_DN_DRIVER-SORTBY.
        IT_PICK_DRIVER-ROUND = IT_DN_DRIVER-ROUND.
        IT_PICK_DRIVER-DOCK = IT_DN_DRIVER-DOCK.
      ENDIF.
      IT_PICK_DRIVER-TOTAL_ITEMS = 0.
      IT_PICK_DRIVER-TOTAL_GWGHT = 0.
      IT_PICK_DRIVER-TOTAL_DLQTY = 0.
      IT_PICK_DRIVER-GEWEI = 'LB'.
      APPEND IT_PICK_DRIVER.
      CLEAR IT_PICK_DRIVER.
    ENDIF.
ENDLOOP.

DELETE IT_PICK_TYPE WHERE TYPENO = ''.
SORT IT_PICK_TYPE BY PLANT TYPENO ASCENDING.

DELETE IT_PICK_DRIVER WHERE TYPENO = ''.
SORT IT_PICK_DRIVER BY PLANT TYPENO SORTBY ASCENDING.

LOOP AT IT_PICK_TYPE ASSIGNING <IT_PICK_TYPE>.
IT_TITEMER[] = IT_DN_ITEMER[].
DELETE IT_TITEMER WHERE WERKS <> <IT_PICK_TYPE>-PLANT.
DELETE IT_TITEMER WHERE TYPENO <> <IT_PICK_TYPE>-TYPENO.
DELETE IT_TITEMER WHERE SO_TYPE = 'RE'.
DELETE IT_TITEMER WHERE MTART = 'ZNLA'.
"总毛重
LOOP AT IT_TITEMER.
<IT_PICK_TYPE>-TOTAL_GWGHT = <IT_PICK_TYPE>-TOTAL_GWGHT + IT_TITEMER-BRGEW.
ENDLOOP.
"该类别下的总司机个数
LOOP AT IT_PICK_DRIVER WHERE PLANT = <IT_PICK_TYPE>-PLANT AND DN_DATE = <IT_PICK_TYPE>-DN_DATE AND TYPENO = <IT_PICK_TYPE>-TYPENO.
<IT_PICK_TYPE>-TOTAL_DRIVER = <IT_PICK_TYPE>-TOTAL_DRIVER + 1.
ENDLOOP.
"货品种类数量
SORT IT_TITEMER BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING MATNR.
<IT_PICK_TYPE>-TOTAL_ITEMS = LINES( IT_TITEMER ).
ENDLOOP.

LOOP AT IT_PICK_DRIVER ASSIGNING <IT_PICK_DRIVER>.
IT_TITEMER[] = IT_DN_ITEMER[].
DELETE IT_TITEMER WHERE WERKS <> <IT_PICK_DRIVER>-PLANT.
DELETE IT_TITEMER WHERE TYPENO <> <IT_PICK_DRIVER>-TYPENO.
DELETE IT_TITEMER WHERE SJZ1_NUM <> <IT_PICK_DRIVER>-SJZ1_NUM.
DELETE IT_TITEMER WHERE SO_TYPE = 'RE'.
DELETE IT_TITEMER WHERE MTART = 'ZNLA'.
"总毛重 & 总销售数量（不区分单位）
LOOP AT IT_TITEMER.
<IT_PICK_DRIVER>-TOTAL_GWGHT = <IT_PICK_DRIVER>-TOTAL_GWGHT + IT_TITEMER-BRGEW.
<IT_PICK_DRIVER>-TOTAL_DLQTY = <IT_PICK_DRIVER>-TOTAL_DLQTY + IT_TITEMER-LFIMG.
ENDLOOP.
"货品种类数量
SORT IT_TITEMER BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING MATNR.
<IT_PICK_DRIVER>-TOTAL_ITEMS = LINES( IT_TITEMER ).
ENDLOOP.

"过滤磅重为0的司机记录
DELETE IT_PICK_DRIVER WHERE TOTAL_GWGHT = 0.

"统计分类后各司机的执货物品信息
IT_TITEMER[] = IT_DN_ITEMER[].
DELETE IT_TITEMER WHERE SO_TYPE = 'ZPM'.
DELETE IT_TITEMER WHERE SO_TYPE = 'ZYB'.
DELETE IT_TITEMER WHERE SO_TYPE = 'RE'.
DELETE IT_TITEMER WHERE MTART = 'ZNLA'.
SORT IT_TITEMER BY WERKS TYPENO SJZ1_NUM MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING WERKS TYPENO SJZ1_NUM MATNR.
LOOP AT IT_TITEMER.
CLEAR IT_PICK_ITEMS.
IT_PICK_ITEMS-PLANT = IT_TITEMER-WERKS.
IT_PICK_ITEMS-DN_DATE = IT_TITEMER-DN_DATE.
IT_PICK_ITEMS-TYPENO = IT_TITEMER-TYPENO.
IT_PICK_ITEMS-TYPENOTXT = IT_TITEMER-TYPENOTXT.
IT_PICK_ITEMS-SJZ1_NUM = IT_TITEMER-SJZ1_NUM.
IT_PICK_ITEMS-SJZ1_NAM = IT_TITEMER-SJZ1_NAM.
IT_PICK_ITEMS-LGNUM = IT_TITEMER-LGNUM.
IT_PICK_ITEMS-MTART = IT_TITEMER-MTART.
IT_PICK_ITEMS-MATKL = IT_TITEMER-MATKL.
IT_PICK_ITEMS-SCTID = IT_TITEMER-SCTID.
IT_PICK_ITEMS-EXTWG = IT_TITEMER-EXTWG.
IT_PICK_ITEMS-MATNR = IT_TITEMER-MATNR.
IT_PICK_ITEMS-ARKTX = IT_TITEMER-ARKTX.
IT_PICK_ITEMS-MATAG1 = IT_TITEMER-MATAG1.
IT_PICK_ITEMS-SOTEXT2 = IT_TITEMER-SOTEXT2.   "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
IT_PICK_ITEMS-PRESALE = IT_TITEMER-PRESALE.   "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
IT_PICK_ITEMS-KONDM = IT_TITEMER-QC_TYPE.
IT_PICK_ITEMS-ZITMTXT01 = IT_TITEMER-QC_TEXT.
"判断当前司机的物料是否有要QC
IT_PICK_ITEMS-MATAG2 = ''.
READ TABLE IT_DN_ITEMER WITH KEY WERKS = IT_TITEMER-WERKS
SJZ1_NUM = IT_TITEMER-SJZ1_NUM
MATNR = IT_TITEMER-MATNR
QC_TYPE = '03'.
IF SY-SUBRC = 0.
IT_PICK_ITEMS-MATAG2 = 'QC'.
ENDIF.
IT_PICK_ITEMS-WHTXT = IT_TITEMER-WHTXT.
IT_PICK_ITEMS-SOTXT = IT_TITEMER-SOTXT.
IT_PICK_ITEMS-MEINS = IT_TITEMER-MEINS.
IT_PICK_ITEMS-TOTAL_QUNTY = 0.
IT_PICK_ITEMS-VRKME = IT_TITEMER-VRKME.
IT_PICK_ITEMS-TOTAL_NWGHT = 0.
IT_PICK_ITEMS-TOTAL_GWGHT = 0.
"汇总数量、净重和毛重
LOOP AT IT_DN_ITEMER WHERE ( SO_TYPE <> 'ZPM' AND SO_TYPE <> 'ZYB' AND SO_TYPE <> 'RE' AND MTART <> 'ZNLA')
AND WERKS = IT_TITEMER-WERKS AND TYPENO = IT_TITEMER-TYPENO AND SJZ1_NUM = IT_TITEMER-SJZ1_NUM AND  MATNR = IT_TITEMER-MATNR.
IT_PICK_ITEMS-TOTAL_QUNTY = IT_PICK_ITEMS-TOTAL_QUNTY + IT_DN_ITEMER-LFIMG.
IT_PICK_ITEMS-TOTAL_NWGHT = IT_PICK_ITEMS-TOTAL_NWGHT + IT_DN_ITEMER-NTGEW.
IT_PICK_ITEMS-TOTAL_GWGHT = IT_PICK_ITEMS-TOTAL_GWGHT + IT_DN_ITEMER-BRGEW.
ENDLOOP.
IT_PICK_ITEMS-GEWEI = IT_TITEMER-GEWEI.
IT_PICK_ITEMS-SETWEIGHT = IT_TITEMER-SETWEIGHT.
IT_PICK_ITEMS-LTKZA = IT_TITEMER-LTKZA.
IT_PICK_ITEMS-SORTBY = IT_TITEMER-SORTBY.
IT_PICK_ITEMS-ONHAND = IT_TITEMER-ONHAND.
IT_PICK_ITEMS-TOMIPO = IT_TITEMER-TOMIPO.
APPEND IT_PICK_ITEMS.
ENDLOOP.

"***************提取Check货单数据******************************************************
"直接把当前SO APP的出货司机赋值到2号检查人员
IT_CHECK_DRIVER[] = IT_DN_DRIVER[].
"过滤纯Yamiemal的司机
DELETE IT_CHECK_DRIVER WHERE DLY_TYPE = '02'.

IT_TITEMER[] = IT_DN_ITEMER[].
DELETE IT_TITEMER WHERE SO_TYPE = 'ZPM'.
DELETE IT_TITEMER WHERE SO_TYPE = 'ZYB'.
DELETE IT_TITEMER WHERE SO_TYPE = 'RE'.
DELETE IT_TITEMER WHERE MTART = 'ZNLA'.
SORT IT_TITEMER BY WERKS SJZ1_NUM TYPENO ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING WERKS SJZ1_NUM TYPENO.
LOOP AT IT_TITEMER.
CLEAR IT_CHECK_DRTYPE.
IT_CHECK_DRTYPE-PLANT = IT_TITEMER-WERKS.
IT_CHECK_DRTYPE-DN_DATE = IT_TITEMER-DN_DATE.
IT_CHECK_DRTYPE-SJZ1_NUM = IT_TITEMER-SJZ1_NUM.
IT_CHECK_DRTYPE-SJZ1_NAM = IT_TITEMER-SJZ1_NAM.
IT_CHECK_DRTYPE-TYPENO = IT_TITEMER-TYPENO.
IT_CHECK_DRTYPE-TYPENOTXT = IT_TITEMER-TYPENOTXT.

    "总毛重 & 总销售数量（不区分单位）
    IT_CHECK_DRTYPE-TOTAL_GWGHT = 0.
    IT_CHECK_DRTYPE-GEWEI = 'LB'.
    IT_CHECK_DRTYPE-TOTAL_DLQTY = 0.
    LOOP AT IT_DN_ITEMER WHERE ( SO_TYPE <> 'ZPM' AND SO_TYPE <> 'ZYB' AND SO_TYPE <> 'RE' AND MTART <> 'ZNLA')
      AND WERKS = IT_TITEMER-WERKS AND SJZ1_NUM = IT_TITEMER-SJZ1_NUM AND TYPENO = IT_TITEMER-TYPENO.
      IT_CHECK_DRTYPE-TOTAL_GWGHT = IT_CHECK_DRTYPE-TOTAL_GWGHT + IT_DN_ITEMER-BRGEW.
      IT_CHECK_DRTYPE-TOTAL_DLQTY = IT_CHECK_DRTYPE-TOTAL_DLQTY + IT_DN_ITEMER-LFIMG.
    ENDLOOP.

    "货品种类数量
    IT_CHECK_DRTYPE-TOTAL_ITEMS = 0.
    IT_TTEMPER[] = IT_DN_ITEMER[].
    DELETE IT_TTEMPER WHERE SO_TYPE = 'ZPM'.
    DELETE IT_TTEMPER WHERE SO_TYPE = 'ZYB'.
    DELETE IT_TTEMPER WHERE SO_TYPE = 'RE'.
    DELETE IT_TTEMPER WHERE MTART = 'ZNLA'.
    DELETE IT_TTEMPER  WHERE WERKS <> IT_TITEMER-WERKS.
    DELETE IT_TTEMPER  WHERE SJZ1_NUM <> IT_TITEMER-SJZ1_NUM.
    DELETE IT_TTEMPER  WHERE TYPENO <> IT_TITEMER-TYPENO.
    SORT IT_TTEMPER BY MATNR ASCENDING.
    DELETE ADJACENT DUPLICATES FROM IT_TTEMPER COMPARING MATNR.
    IT_CHECK_DRTYPE-TOTAL_ITEMS = LINES( IT_TTEMPER ).
    APPEND IT_CHECK_DRTYPE.
ENDLOOP.
SORT IT_CHECK_DRTYPE BY PLANT DN_DATE SJZ1_NUM TYPENO ASCENDING.

"统计司机后各分类执货物品信息
IT_TITEMER[] = IT_DN_ITEMER[].
DELETE IT_TITEMER WHERE SO_TYPE = 'ZPM'.
DELETE IT_TITEMER WHERE SO_TYPE = 'ZYB'.
DELETE IT_TITEMER WHERE SO_TYPE = 'RE'.
DELETE IT_TITEMER WHERE MTART = 'ZNLA'.
SORT IT_TITEMER BY WERKS SJZ1_NUM TYPENO MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM IT_TITEMER COMPARING WERKS SJZ1_NUM TYPENO MATNR.
LOOP AT IT_TITEMER.
CLEAR IT_CHECK_ITEMS.
IT_CHECK_ITEMS-PLANT = IT_TITEMER-WERKS.
IT_CHECK_ITEMS-DN_DATE = IT_TITEMER-DN_DATE.
IT_CHECK_ITEMS-TYPENO = IT_TITEMER-TYPENO.
IT_CHECK_ITEMS-TYPENOTXT = IT_TITEMER-TYPENOTXT.
IT_CHECK_ITEMS-SJZ1_NUM = IT_TITEMER-SJZ1_NUM.
IT_CHECK_ITEMS-SJZ1_NAM = IT_TITEMER-SJZ1_NAM.
IT_CHECK_ITEMS-LGNUM = IT_TITEMER-LGNUM.
IT_CHECK_ITEMS-MTART = IT_TITEMER-MTART.
IT_CHECK_ITEMS-SOTEXT2 = IT_TITEMER-SOTEXT2.   "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
IT_CHECK_ITEMS-PRESALE = IT_TITEMER-PRESALE.   "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
IT_CHECK_ITEMS-KONDM = IT_TITEMER-QC_TYPE.
IT_CHECK_ITEMS-ZITMTXT01 = IT_TITEMER-QC_TEXT.
"判断物料类型
IT_CHECK_ITEMS-CKTYP = ''.
IF IT_TITEMER-MTART = 'ZHW1' OR IT_TITEMER-MTART = 'ZHW2' OR IT_TITEMER-MTART = 'ZHW3' OR
IT_TITEMER-MTART = 'ZHW4' OR IT_TITEMER-MTART = 'ZHW5' OR IT_TITEMER-MTART = 'ZHW6'.
IT_CHECK_ITEMS-CKTYP = 'MEAT'.
ELSEIF IT_TITEMER-MTART = 'ZHW7'.
IT_CHECK_ITEMS-CKTYP = 'VEG'.
ELSE.
IT_CHECK_ITEMS-CKTYP = 'DRY'.
ENDIF.

    IT_CHECK_ITEMS-MATKL = IT_TITEMER-MATKL.
    IT_CHECK_ITEMS-SCTID = IT_TITEMER-SCTID.
    IT_CHECK_ITEMS-EXTWG = IT_TITEMER-EXTWG.
    IT_CHECK_ITEMS-MATNR = IT_TITEMER-MATNR.
    IT_CHECK_ITEMS-ARKTX = IT_TITEMER-ARKTX.
    IT_CHECK_ITEMS-MATAG1 = IT_TITEMER-MATAG1.
    "判断当前是否有QC
    IT_CHECK_ITEMS-MATAG2 = ''.
    READ TABLE IT_DN_ITEMER WITH KEY  WERKS = IT_TITEMER-WERKS
      SJZ1_NUM = IT_TITEMER-SJZ1_NUM
      MATNR = IT_TITEMER-MATNR
      QC_TYPE = '03'.
    IF SY-SUBRC = 0.
      IT_CHECK_ITEMS-MATAG2 = 'QC'.
    ENDIF.
    IT_CHECK_ITEMS-WHTXT = IT_TITEMER-WHTXT.
    IT_CHECK_ITEMS-SOTXT = IT_TITEMER-SOTXT.
    IT_CHECK_ITEMS-MEINS = IT_TITEMER-MEINS.
    IT_CHECK_ITEMS-TOTAL_QUNTY = 0.
    IT_CHECK_ITEMS-VRKME = IT_TITEMER-VRKME.
    IT_CHECK_ITEMS-TOTAL_NWGHT = 0.
    IT_CHECK_ITEMS-TOTAL_GWGHT = 0.
    IT_CHECK_ITEMS-SOTEXT2 = IT_TITEMER-SOTEXT2.          "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
    IT_CHECK_ITEMS-PRESALE = IT_TITEMER-PRESALE.          "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
    "汇总数量、净重和毛重
    LOOP AT IT_DN_ITEMER WHERE ( SO_TYPE <> 'ZPM' AND SO_TYPE <> 'ZYB' AND SO_TYPE <> 'RE' AND MTART <> 'ZNLA')
     AND WERKS = IT_TITEMER-WERKS AND SJZ1_NUM = IT_TITEMER-SJZ1_NUM AND TYPENO = IT_TITEMER-TYPENO  AND  MATNR = IT_TITEMER-MATNR.
      IT_CHECK_ITEMS-TOTAL_QUNTY = IT_CHECK_ITEMS-TOTAL_QUNTY + IT_DN_ITEMER-LFIMG.
      IT_CHECK_ITEMS-TOTAL_NWGHT = IT_CHECK_ITEMS-TOTAL_NWGHT + IT_DN_ITEMER-NTGEW.
      IT_CHECK_ITEMS-TOTAL_GWGHT = IT_CHECK_ITEMS-TOTAL_GWGHT + IT_DN_ITEMER-BRGEW.
    ENDLOOP.
    IT_CHECK_ITEMS-GEWEI = IT_TITEMER-GEWEI.
    IT_CHECK_ITEMS-SETWEIGHT = IT_TITEMER-SETWEIGHT.
    IT_CHECK_ITEMS-LTKZA  = IT_TITEMER-LTKZA.
    IT_CHECK_ITEMS-SORTBY = IT_TITEMER-SORTBY.
    IT_CHECK_ITEMS-ONHAND = IT_TITEMER-ONHAND.
    IT_CHECK_ITEMS-TOMIPO = IT_TITEMER-TOMIPO.
    APPEND IT_CHECK_ITEMS.
ENDLOOP.

"***************提取物料汇总信息:排除Yamimeal订单*****************************************************
LOOP AT IT_DN_ITEMER WHERE SO_TYPE <> 'ZPM' AND MTART <> 'ZNLA'.
READ TABLE IT_SUB_ITEMER WITH KEY WERKS = IT_DN_ITEMER-WERKS MATNR = IT_DN_ITEMER-MATNR.
IF SY-SUBRC <> 0.
CLEAR IT_SUB_ITEMER.
IT_SUB_ITEMER-WERKS = IT_DN_ITEMER-WERKS.
IT_SUB_ITEMER-MTART = IT_DN_ITEMER-MTART.
IT_SUB_ITEMER-MATKL = IT_DN_ITEMER-MATKL.
IT_SUB_ITEMER-MATNR = IT_DN_ITEMER-MATNR.
IT_SUB_ITEMER-ARKTX = IT_DN_ITEMER-ARKTX.
IT_SUB_ITEMER-MATAG1 = IT_DN_ITEMER-MATAG1.
IT_SUB_ITEMER-WHTXT = IT_DN_ITEMER-WHTXT.
IT_SUB_ITEMER-SOTXT = IT_DN_ITEMER-SOTXT.
IT_SUB_ITEMER-SBTOTL = 0.
IT_SUB_ITEMER-VRKME = IT_DN_ITEMER-VRKME.
IT_SUB_ITEMER-ONHAND = IT_DN_ITEMER-ONHAND .
IT_SUB_ITEMER-TOMIPO = IT_DN_ITEMER-TOMIPO.
IT_SUB_ITEMER-SOTEXT2 = IT_DN_ITEMER-SOTEXT2.       "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
IT_SUB_ITEMER-PRESALE = IT_DN_ITEMER-PRESALE.       "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
IT_SUB_ITEMER-TYPENO = IT_DN_ITEMER-TYPENO.         "#4477(1) 添加返回字段Section Type Number Description_MODIFY BY RT 20220501
IT_SUB_ITEMER-TYPENOTXT = IT_DN_ITEMER-TYPENOTXT.   "#4477(1) 添加返回字段Section Type Number Description_MODIFY BY RT 20220501
APPEND IT_SUB_ITEMER.
ENDIF.
ENDLOOP.

"汇总数量
LOOP AT IT_SUB_ITEMER ASSIGNING <IT_SUB_ITEMER>.
LOOP AT IT_DN_ITEMER WHERE WERKS = <IT_SUB_ITEMER>-WERKS AND MATNR = <IT_SUB_ITEMER>-MATNR.
<IT_SUB_ITEMER>-SBTOTL = <IT_SUB_ITEMER>-SBTOTL + IT_DN_ITEMER-LFIMG.
ENDLOOP.
ENDLOOP.

"排序
SORT IT_SUB_ITEMER BY WERKS MTART MATKL MATNR ASCENDING.
"***************提取执货单数据******************************************************

"***************提取LMI数据:排除Yamimeal订单*****************************************************
IT_TTEMPER[] = IT_DN_ITEMER[].
DELETE IT_TTEMPER WHERE SO_TYPE = 'ZPM'.
DELETE IT_TTEMPER WHERE SO_TYPE = 'RE'.
DELETE IT_TTEMPER WHERE SCTID NOT IN R_SCTID.

LOOP AT IT_TTEMPER ASSIGNING <IT_TITEMER>.
"1200货仓区分街道，其他货仓不区分
IF <IT_TITEMER>-WERKS = '1200'.
IF <IT_TITEMER>-DOCK = 'DOCK#01' OR <IT_TITEMER>-DOCK = 'DOCK#02' OR <IT_TITEMER>-DOCK = 'DOCK#03' OR <IT_TITEMER>-DOCK = 'DOCK#04' OR <IT_TITEMER>-DOCK = 'DOCK#05'.
<IT_TITEMER>-DOCK = '625'.
ELSEIF <IT_TITEMER>-DOCK = 'DOCK#06' OR <IT_TITEMER>-DOCK = 'DOCK#07' OR <IT_TITEMER>-DOCK = 'DOCK#08' OR <IT_TITEMER>-DOCK = 'DOCK#09' OR <IT_TITEMER>-DOCK = 'DOCK#10'.
<IT_TITEMER>-DOCK = '615'.
ENDIF.
ENDIF.

    READ TABLE IT_SUB_LMI_ITM WITH KEY MTYPE = <IT_TITEMER>-DOCK  WERKS = <IT_TITEMER>-WERKS MATNR = <IT_TITEMER>-MATNR.
    IF SY-SUBRC <> 0.
      CLEAR IT_SUB_ITEMER.
      IT_SUB_LMI_ITM-WERKS = <IT_TITEMER>-WERKS.
      IT_SUB_LMI_ITM-MTYPE = <IT_TITEMER>-DOCK.
      IT_SUB_LMI_ITM-MATNR = <IT_TITEMER>-MATNR.
      IT_SUB_LMI_ITM-ARKTX = <IT_TITEMER>-ARKTX.
      IT_SUB_LMI_ITM-WHTXT = <IT_TITEMER>-WHTXT.
      IT_SUB_LMI_ITM-SOTXT = <IT_TITEMER>-SOTXT.
      IT_SUB_LMI_ITM-SBTOTL = 0.
      IT_SUB_LMI_ITM-VRKME = <IT_TITEMER>-VRKME.
      IT_SUB_LMI_ITM-SOTEXT2 = <IT_TITEMER>-SOTEXT2.          "#3682 新增字段:SOTEXT2(Z11)__By Doris 20210622
      IT_SUB_LMI_ITM-PRESALE = <IT_TITEMER>-PRESALE.         "#3816 增加预售字段{PRESALE__Modify By Doris 20210808
      IT_SUB_LMI_ITM-KONDM = IT_TITEMER-QC_TYPE.
      IT_SUB_LMI_ITM-ZITMTXT01 = IT_TITEMER-QC_TEXT.
      APPEND IT_SUB_LMI_ITM.
    ENDIF.
ENDLOOP.

"汇总数量
LOOP AT IT_SUB_LMI_ITM ASSIGNING <IT_SUB_LMI_ITM>.
LOOP AT IT_TTEMPER WHERE DOCK = <IT_SUB_LMI_ITM>-MTYPE AND WERKS = <IT_SUB_LMI_ITM>-WERKS AND MATNR = <IT_SUB_LMI_ITM>-MATNR.
<IT_SUB_LMI_ITM>-SBTOTL = <IT_SUB_LMI_ITM>-SBTOTL + IT_TTEMPER-LFIMG.
ENDLOOP.
ENDLOOP.

SORT IT_SUB_LMI_ITM BY WERKS MTYPE MATNR ASCENDING.
"***************提取LMI数据******************************************************

"返回状态
IF LINES( IT_DN_ITEMER ) >= 0.
O_STATUS = 'S'.
O_MESSAGE = 'Successfully!'.
ENDIF.

*********************************************************
"用于记录接口执行时间
GET TIME STAMP FIELD LV_END_TIMESTAMP.
CALL FUNCTION 'ZRFSY007'
EXPORTING
I_UNAME = SY-UNAME
I_RFCNM = 'ZRFWM048'
I_STIME = LV_STR_TIMESTAMP
I_ETIME = LV_END_TIMESTAMP.
*********************************************************

ENDFUNCTION.

***********************************************************
*通用方法获取TEXT信息
***********************************************************
FORM READ_SO_TEXT
USING
ID TYPE THEAD-TDID
LV_STRNAME TYPE STRING
OBJECT TYPE THEAD-TDOBJECT
RETURNTXT TYPE CHAR255.

DATA: L_NAME TYPE THEAD-TDNAME.
DATA: T_LINES LIKE TABLE OF TLINE WITH HEADER LINE .
L_NAME = LV_STRNAME.
CALL FUNCTION 'READ_TEXT'
EXPORTING
CLIENT                  = SY-MANDT
ID                      = ID
LANGUAGE                = SY-LANGU
NAME                    = L_NAME
OBJECT                  = OBJECT
TABLES
LINES                   = T_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.
IF SY-SUBRC = 0.
"处理特殊字符
LOOP AT T_LINES.
REPLACE ALL OCCURRENCES OF '<(>' IN T_LINES-TDLINE WITH ''.
REPLACE ALL OCCURRENCES OF '<)>' IN T_LINES-TDLINE WITH ''.
IF T_LINES-TDLINE <> ''.
CONCATENATE RETURNTXT  T_LINES-TDLINE ';' INTO RETURNTXT .
ENDIF.
ENDLOOP.
ENDIF.
ENDFORM.
```

### Warehouse Workbench

```c#

 public void SyncSAPDailyData(DateTime deliveryDate, string plant, string driver, string soNumber)
        {
            try
            {
                var requireUrl = $"{AppSettingConfig.SapApiUrl}/api/ZRFWM048/GetDailySoDnData";
                var obj048 = new BaseAPI().PostModelAndReturnModel<ZRFWM048, ZRFWM048>(requireUrl, "", new ZRFWM048()
                {
                    I_ZDATE = deliveryDate.Date,
                    I_PLANT = plant,
                    I_DRIVER = driver,
                    I_SALES_ORDER = soNumber
                });


                //从数据库查询数据
                using (var dbClient = db.GetInstance(DB.db_wm.GetAttributeValue()))
                {
                    var dbSoList = dbClient.Queryable<tb_270_it_dn_header>()
                        .Where(x => x.LFDAT == deliveryDate)
                        .WhereIF(!string.IsNullOrEmpty(plant), x => x.VSTEL == plant)
                        .WhereIF(!string.IsNullOrEmpty(driver), x => x.SJZ1_NAM == driver)
                        .WhereIF(!string.IsNullOrEmpty(soNumber), x => x.SO_NUM == soNumber)
                        .ToList();


                    var dbSoItemList = dbClient.Queryable<tb_271_it_dn_itemer>()
                        .Where(x => x.FKDAT == deliveryDate)
                        .WhereIF(!string.IsNullOrEmpty(plant), x => x.VSTEL == plant)
                        .WhereIF(!string.IsNullOrEmpty(soNumber), x => x.SO_NUM == soNumber)
                        .ToList();

                    //由于数据库表SOItem没有司机字段，所以数据库查询出的SoItem会比较多，使用内连接后得到真实的数据库存在的SOItem
                    var dbSoItemListAct = (from a in dbSoList
                                           join b in dbSoItemList on a.SO_NUM equals b.SO_NUM
                                           select b).ToList();



                    //SAP 数据与DB数据左连接
                    var joinSoOrderList = (from a in obj048.IT_DN_HEADER
                                           join b in dbSoList on a.SO_NUM equals b.SO_NUM into bb
                                           from c in bb.DefaultIfEmpty()
                                           select new tb_270_it_dn_header
                                           {
                                               SO_TYPE = a.SO_TYPE,
                                               SO_NUM = a.SO_NUM,
                                               DN_TYPE = a.DN_TYPE,
                                               VSBED = a.VSBED,
                                               VSTEL = a.VSTEL,
                                               LFDAT = a.LFDAT,
                                               SHIPTO_NAM = a.SHIPTO_NAM,
                                               SHIPTO_NUM = a.SHIPTO_NUM,
                                               BTGEW = a.BTGEW,
                                               NTGEW = a.NTGEW,
                                               GEWEI = a.GEWEI,
                                               SJZ1_NUM = a.SJZ1_NUM,
                                               SJZ1_NAM = a.SJZ1_NAM,
                                               SJZ3_NUM = a.SJZ3_NUM,
                                               SJZ3_NAM = a.SJZ3_NAM,
                                               SJZ4_NUM = a.SJZ4_NUM,
                                               SJZ4_NAM = a.SJZ4_NAM,
                                               ROUND = a.ROUND,
                                               ToStatus = c?.ToStatus,
                                               PgiStatus = c?.PgiStatus,
                                               InvoiceStatus = c?.InvoiceStatus,
                                               InvoiceNo = c?.InvoiceNo,
                                               DN_NUM = a.DN_NUM,
                                               UploadYamimealStatus = c?.UploadYamimealStatus,
                                               ChangeYamimealOrderStatus = c?.ChangeYamimealOrderStatus

                                           }).ToList();

                    //SAP Item表串DB Item表 串 SAP Header表
                    var joinSoOrderItemList = (from a in obj048.IT_DN_ITEMER
                                               join b in dbSoItemListAct on new { a.SO_NUM, a.SO_ITEM } equals new { b.SO_NUM, b.SO_ITEM } into bb
                                               from c in bb.DefaultIfEmpty()
                                               join d in obj048.IT_DN_HEADER on a.SO_NUM equals d.SO_NUM into dd
                                               from e in dd.DefaultIfEmpty()
                                               select new tb_271_it_dn_itemer
                                               {
                                                   FKDAT = e.LFDAT,
                                                   VSTEL = e.VSTEL,
                                                   SO_NUM = a.SO_NUM,
                                                   SO_ITEM = a.SO_ITEM,
                                                   DN_NUM = a.DN_NUM,
                                                   DN_ITEM = a.DN_ITEM,
                                                   MTART = a.MTART,
                                                   MATKL = a.MATKL,
                                                   EXTWG = a.EXTWG,
                                                   MATNR = a.MATNR,
                                                   ARKTX = a.ARKTX,
                                                   WHTXT = a.WHTXT,
                                                   MEINS = a.MEINS,
                                                   LFIMG = a.LFIMG,
                                                   VRKME = a.VRKME,
                                                   NTGEW = a.NTGEW,
                                                   BRGEW = a.BRGEW,
                                                   GEWEI = a.GEWEI,
                                                   SETWEIGHT = a.SETWEIGHT,
                                                   WHOUSE_TEXT1 = a.WHOUSE_TEXT1,
                                                   QC_TYPE = a.QC_TYPE,
                                                   QC_TEXT = a.QC_TEXT,
                                                   UploadCatchWeightStatus = c?.UploadCatchWeightStatus
                                               }).ToList();


                    //通过差集得到新的数据
                    var newSoOrder = joinSoOrderList.Except(dbSoList, x => MySqlSugar.JsonConverter.Serialize(x))
                        .ToList();
                    var newSoOrderItems = joinSoOrderItemList
                        .Except(dbSoItemListAct, x => MySqlSugar.JsonConverter.Serialize(x)).ToList();
                    //插入新数据
                    dbClient.InsertDuplicateKey(newSoOrder);
                    dbClient.InsertDuplicateKey(newSoOrderItems);

                    //反向差集得到DB中冗作数据
                    var outSoOrder = dbSoList.Except(joinSoOrderList, x => new { x.LFDAT, x.SO_NUM }).ToList();
                    var outSoOrderItems = dbSoItemListAct
                        .Except(joinSoOrderItemList, x => new { x.FKDAT, x.SO_NUM, x.SO_ITEM }).ToList();

                    dbClient.Delete(outSoOrder);
                    dbClient.Delete(outSoOrderItems);
                }



                //同步SAP Out貨Item
                SyncSapOutSo(deliveryDate, plant);
            }
            catch (Exception ex)
            {
                throw ex;
            }
        }

```
